<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="RestorePackagesRequiredForVsix" BeforeTargets="BeforeBuild">
    
    <PropertyGroup>
      <SolutionDir Condition=" '$(SolutionDir)' == '' OR '$(SolutionDir)' == '*Undefined*' ">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), more.sln))</SolutionDir>
      <SolutionDir>$(SolutionDir.TrimEnd('\'))</SolutionDir>
    </PropertyGroup>
    
    <ItemGroup>
      <InstalledNuGetCliPackage Include="$(SolutionDir)\packages\NuGet.CommandLine.*\tools\nuget.exe" />
    </ItemGroup>
    
    <PropertyGroup>
      <PackagesDir>$(ProjectDir)$(BaseIntermediateOutputPath)packages</PackagesDir>
      <NewestNuGetExe>@(InstalledNuGetCliPackage->Reverse())</NewestNuGetExe>
      <NuGetExe Condition=" '$(NuGetExe)' == '' ">$(NewestNuGetExe.Split(`;`)[0])</NuGetExe>
      <PackageConfig>$(ProjectDir)packages.build.config</PackageConfig>
    </PropertyGroup>
    
    <Exec Command="&quot;$(NuGetExe)&quot; restore &quot;$(PackageConfig)&quot; -PackagesDirectory &quot;$(PackagesDir)&quot; -SolutionDirectory &quot;$(SolutionDir)&quot; -NonInteractive -Verbosity quiet" />

    <ItemGroup>
      <Content Include="$(SolutionDir)\bin\*.nupkg" Exclude="$(SolutionDir)\bin\More.AspNet.Hosting*.nupkg">
        <Link>Packages\%(FileName)%(Extension)</Link>
        <CopyToOutputDirectory>Always</CopyToOutputDirectory>
        <IncludeInVSIX>true</IncludeInVSIX>
      </Content>
      <Content Include="$(PackagesDir)\*.nupkg">
        <Link>Packages\%(FileName)%(Extension)</Link>
        <CopyToOutputDirectory>Always</CopyToOutputDirectory>
        <IncludeInVSIX>true</IncludeInVSIX>
      </Content>
    </ItemGroup>
  
  </Target>

  <Target Name="BuildPackagesConfigElements" Condition=" '@(ProjectReference)' != '' ">

    <MSBuild Projects="%(ProjectReference.Identity)"
             Targets="ResolvePackageReferences"
  	         UnloadProjectsOnCompletion="true"
  	         Condition=" '%(ProjectReference.ReferenceOutputAssembly)' == 'false' ">
      <Output TaskParameter="TargetOutputs" ItemName="PackageReference" />
    </MSBuild>

    <ItemGroup>
      <DistinctPackageReference Include="@(PackageReference->Distinct())" />
    </ItemGroup>

    <PropertyGroup>
      <PackagesConfigLines>@(DistinctPackageReference->'  &lt;package id=&quot;%(Identity)&quot; version=&quot;%(Version)&quot; /&gt;','%0D%0A')</PackagesConfigLines>
    </PropertyGroup>

    <ItemGroup>
      <T4ParameterValues Include="PackageElements" Value="$(PackagesConfigLines)" />
    </ItemGroup>

  </Target>

  <Import Project="$(VSToolsPath)\TextTemplating\Microsoft.TextTemplating.targets" Condition="Exists('$(VSToolsPath)\TextTemplating\Microsoft.TextTemplating.targets') " />

</Project>